using System.Collections;
using System.Collections.Generic;
using NUnit.Framework;
using UnityEngine;
using UnityEngine.TestTools;
using U.DalilaDB;
using System.Text.RegularExpressions;
using System;
using System.IO;
using System.Runtime.Serialization;
using System.Data;
using System.Threading.Tasks;

public class DalilaCollection_A1Encryption
{


    #region Example classes

    [KnownType(typeof(UserEncrypted))]
    [DataContract()]
    class UserEncrypted : DalilaDBCollection<UserEncrypted>
    {

        [DataMember()]
        public int count;

        [DataMember()]
        public string name;

        protected override string rootPath_ => Application.persistentDataPath;

        protected override bool _aesEncryption => true;
        protected override DalilaFS.aesValidKeySizes _aesKeySize => DalilaFS.aesValidKeySizes.aes256;
        protected override string _aesFixedKey => "TheKeyIsNew";

    }

    #endregion Example classes


    [SetUp]
    public void SetUp()
    {
        // Delete the directory to clear it
        try { Directory.Delete(UserEncrypted.LocationPath, true); } catch (Exception) { }
        UserEncrypted.DeleteAll();
        UserEncrypted.ResetFileSystem();

    }




    [Test]
    public void A900_IdOfADocumentWontBeNull()
    {

        // Create two documents wiith the same key
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "3333333333333333333", count = 66, name = "Pedro" };

        Assert.IsFalse(newd1._id == null);

        // If you set the key as null
        newd1._id = null;

        // A diferent key will be generated
        Assert.IsFalse(newd1._id == null);
        Assert.IsFalse(newd1._id == "3333333333333333333");

        var newd2 = new UserEncrypted { _id = null, count = 66, name = "Pedro" };

        // A diferent key will be generated
        Assert.IsFalse(newd2._id == null);

    }




    [Test]
    public void A000_Save_TwoDocumentsWithTheSameKey_WillOverwrite()
    {

        // Create two documents wiith the same key
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432069", count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { _id = "4961429416443432069", count = 77, name = "Paco" };

        // The first one will be saved
        var opp1 = newd1.Save();
        Assert.IsTrue(opp1);
        Assert.AreEqual(1, (int)opp1);
        Assert.AreEqual(66, UserEncrypted.FindById("4961429416443432069").Data.count);

        // And The second one will overwrite the first
        var opp2 = newd2.Save();
        Assert.IsTrue(opp2);
        Assert.AreEqual(1, (int)opp2);
        Assert.AreEqual(77, UserEncrypted.FindById("4961429416443432069").Data.count);

        // The first one will be overwrite again
        var opp3 = newd1.Save();
        Assert.IsTrue(opp3);
        Assert.AreEqual(1, (int)opp3);
        Assert.AreEqual(66, UserEncrypted.FindById("4961429416443432069").Data.count);

    }

    [Test]
    public void A003_Save_DiferentKeyIsAutoGeneratedIfNotSet()
    {

        // Create two documents wiith the same key
        UserEncrypted.Define();
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" }.Save();
        var newd2 = new UserEncrypted { count = 77, name = "Paco" }.Save();
        UserEncrypted.Define();
        var key1 = UserEncrypted.FindOne(u => u.count == 66).Data._id;
        var key2 = UserEncrypted.FindOne(u => u.count == 77).Data._id;

        // Keys are diferent
        Assert.IsFalse(key1 == key2);
        UserEncrypted.Define();
        // Key can be used to find the documents
        Assert.AreEqual(66, UserEncrypted.FindById(key1).Data.count);
        Assert.AreEqual(77, UserEncrypted.FindById(key2).Data.count);

    }


    [Test]
    public void A060_Save_CanSaveAnIEnumerableOfTypeCollection()
    {

        // Create two documents wiith the same key
        UserEncrypted.Define();
        Debug.Log("Save");
        var list = new UserEncrypted[]
        {
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
        };
        var opp = list.Save();
        Assert.IsTrue(opp);
        Assert.AreEqual(6, (int)opp);
        Assert.AreEqual(6, UserEncrypted.Count());
        UserEncrypted.Define();


        // Elements are not overwrited
        opp = list.Save();
        Assert.IsTrue(opp);
        Assert.AreEqual(6, (int)opp);
        Assert.AreEqual(6, UserEncrypted.Count());
        UserEncrypted.Define();

    }



    [Test]
    public void A061_SaveNew_CanSaveAnIEnumerableOfTypeCollection()
    {

        // Create two documents wiith the same key
        UserEncrypted.Define();
        Debug.Log("Save");
        var list = new UserEncrypted[]
        {
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
            new UserEncrypted { count = 66, name = "Pedro" },
        };
        var opp = list.SaveNew();
        Assert.IsTrue(opp);
        Assert.AreEqual(6, (int)opp);
        Assert.AreEqual(6, UserEncrypted.Count());
        UserEncrypted.Define();


        // Elements are overwrited
        opp = list.SaveNew();
        Assert.IsTrue(opp);
        Assert.AreEqual(6, (int)opp);
        Assert.AreEqual(12, UserEncrypted.Count());
        UserEncrypted.Define();

    }




    [Test]
    public void A010_SaveNew_WillGenerateNewRandomKey()
    {

        // Create two documents wiith the same key
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432069", count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { _id = "4961429416443432069", count = 77, name = "Paco" };

        // If SaveNew is used a new key is generated each time for he document
        newd1.SaveNew();
        Assert.IsFalse(newd1._id == "4961429416443432069");
        newd2.SaveNew();
        Assert.IsFalse(newd2._id == "4961429416443432069");
        newd1.SaveNew();
        newd2.SaveNew();

        // Now there are four documents stored
        Assert.IsTrue(UserEncrypted.Count() == 4);

        // And the initial key is not used to save
        Assert.IsFalse(UserEncrypted.Exist("4961429416443432069"));

    }

    [Test]
    public void A013_SaveNew_IfAKeyIsNotSet_OneWillAutoGenerated()
    {

        // Create two documents wiith the no key
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };

        // Save the documents
        Assert.IsTrue(newd1.SaveNew());
        Assert.IsTrue(newd2.SaveNew());

        // Now two documents are stored
        Assert.IsTrue(UserEncrypted.Count() == 2);

        // And the dcuments have diferent keys
        var doc1 = UserEncrypted.FindOne(u => u.name == "Pedro").Data;
        var doc2 = UserEncrypted.FindOne(u => u.name == "Paco").Data;
        Debug.Log("Key1: " + doc1._id + " Key2: " + doc2._id);
        Assert.IsTrue(doc1._id != doc2._id);

    }





    [Test]
    public void A200_FindById_01WillFindAnDocumentByIdOrFindNull()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432069", count = 66, name = "Pedro" };

        // The first one will be saved
        Assert.IsTrue(newd1.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 1);
        Assert.IsTrue(UserEncrypted.Exist("4961429416443432069"));

        // Find the document by the id
        var opp = UserEncrypted.FindById("4961429416443432069");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // If you try to find an unexistent document will return null
        var opp2 = UserEncrypted.FindById("4961429416443432010");
        Assert.IsFalse(opp2);
        Assert.IsTrue(opp2.Data == null);

    }

    [Test]
    public void A203_FindById_62InvalidOrNullKey_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindById(null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindById(""));
        Assert.Throws<FormatException>(() => UserEncrypted.FindById("343432"));
        Assert.Throws<FormatException>(() => UserEncrypted.FindById("f43f34ff"));
        Assert.Throws<FormatException>(() => UserEncrypted.FindById("4332 333 444 55  22"));
        Assert.Throws<FormatException>(() => UserEncrypted.FindById("433232893874673.254"));
        Assert.DoesNotThrow(() => UserEncrypted.FindById("4332328938746732254"));
    }




    [Test]
    public void A250_FindByIdOrDefault_01WillFindAnDocumentByIdOrReturnDefaultPassed()
    {
        var defaultDoc = new UserEncrypted { count = 11, };

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432069", count = 66, name = "Pedro" };

        // The first one will be saved
        Assert.IsTrue(newd1.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 1);
        Assert.IsTrue(UserEncrypted.Exist("4961429416443432069"));

        // Find the document by the id
        var opp = UserEncrypted.FindByIdOrDefault("4961429416443432069", defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // If you try to find an unexistent document will return null
        var opp2 = UserEncrypted.FindByIdOrDefault("4961429416443432010", defaultDoc);
        Assert.IsTrue(opp2);
        Assert.IsTrue(opp2.Data.count == 11);

    }

    [Test]
    public void A253_FindByIdOrDefault_62InvalidOrNullKey_WillThrowError()
    {

        var defaultDoc = new UserEncrypted { count = 11, };

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindByIdOrDefault(null, defaultDoc));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindByIdOrDefault("", defaultDoc));
        Assert.Throws<FormatException>(() => UserEncrypted.FindByIdOrDefault("343432", defaultDoc));
        Assert.Throws<FormatException>(() => UserEncrypted.FindByIdOrDefault("f43f34ff", defaultDoc));
        Assert.Throws<FormatException>(() => UserEncrypted.FindByIdOrDefault("4332 333 444 55  22", defaultDoc));
        Assert.Throws<FormatException>(() => UserEncrypted.FindByIdOrDefault("433232893874673.254", defaultDoc));
        Assert.DoesNotThrow(() => UserEncrypted.FindByIdOrDefault("4332328938746732254", defaultDoc));
    }




    [Test]
    public void A210_FindOne_01WillFindAnDocumentOrFindNull()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 5);

        // Find a document
        var opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);
        // Find a document
        opp = UserEncrypted.FindOne(d => d.count == 77);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 77);
        // Find a document
        opp = UserEncrypted.FindOne(d => d.name == "Ale");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.name == "Ale");
        // Find a document
        opp = UserEncrypted.FindOne(d => d.name == "Juan");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 88);

        // If you try to find an unexistent document will return null
        opp = UserEncrypted.FindOne(d => d.name == "Ema");
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data == null);
        // If you try to find an unexistent document will return null
        opp = UserEncrypted.FindOne(d => d.count == 100);
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data == null);

    }

    [Test]
    public void A211_FindOne_IfPredicateThrowsError_IsLikeDontFindAny()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 5);

        // Find a document
        var opp = UserEncrypted.FindOne(d => throw new Exception("Expected exceptiopn"));
        Assert.IsFalse(opp);

    }

    [Test]
    public void A216_FindOne_61NullPredicate_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindOne(null));
        Assert.DoesNotThrow(() => UserEncrypted.FindOne(d => true));

    }




    [Test]
    public void A270_FindOneOrDefault_01WillFindAnDocumentOrReturnDefaultPassed()
    {
        var defaultDoc = new UserEncrypted { count = 11, };

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 5);

        // Find a document
        var opp = UserEncrypted.FindOneOrDefault(d => d.count == 66, defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);
        // Find a document
        opp = UserEncrypted.FindOneOrDefault(d => d.count == 77, defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 77);
        // Find a document
        opp = UserEncrypted.FindOneOrDefault(d => d.name == "Ale", defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.name == "Ale");
        // Find a document
        opp = UserEncrypted.FindOneOrDefault(d => d.name == "Juan", defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 88);

        // If you try to find an unexistent document will return null
        opp = UserEncrypted.FindOneOrDefault(d => d.name == "Ema", defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 11);
        // If you try to find an unexistent document will return null
        opp = UserEncrypted.FindOneOrDefault(d => d.count == 100, defaultDoc);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 11);

    }

    [Test]
    public void A276_FindOneOrDefault_61NullPredicate_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindOneOrDefault(null, new UserEncrypted()));

    }




    [Test]
    public void A220_FindMany_01WillFindAnArrayOrEmptyArrayAndFalseOperation()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find a document
        var opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach(var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }
        // Find a document
        opp = UserEncrypted.FindMany(d => d.name == "Juan");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.name == "Juan");
        }
        // Find a document
        opp = UserEncrypted.FindMany(d => d.name == "Benito");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 1);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.name == "Benito");
        }
        // If you try to find an unexistent document will return empty array and false
        opp = UserEncrypted.FindMany(d => d.name == "Ema");
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data.Length == 0);

        // If you try to find an unexistent document will return empty array and false
        opp = UserEncrypted.FindMany(d => d.count == 11);
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data.Length == 0);


    }

    [Test]
    public void A221_FindMany_IfPredicateThrowsError_IsLikeDontFindAny()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find a document
        var opp = UserEncrypted.FindMany(d => throw new Exception("Expected exception"));
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data.Length == 0);

    }

    [Test]
    public void A223_FindMany_61NullPredicate_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.FindMany(null));

    }

    [Test]
    public void A226_FindMany_IfLimitPassedOnlyThatreadsWillBeDone()
    {

        // Create one document
        Debug.Log("Save");
        for (int i = 0; i < 20; i++)
            new UserEncrypted { count = i, name = "Pedro" }.Save();

        // 20 one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 20);

        // Find all document will return all
        Assert.AreEqual(14, UserEncrypted.FindMany(u => u.count < 14).Data.Length);

        // Limit will limit reads
        Assert.AreEqual(8, UserEncrypted.FindMany(u => u.count < 14, limit: 8).Data.Length);

        // Limit will limit reads
        Assert.AreEqual(1, UserEncrypted.FindMany(u => u.count < 14, limit: 1).Data.Length);

        // Cero or less will find all
        Assert.AreEqual(14, UserEncrypted.FindMany(u => u.count < 14, limit: -1).Data.Length);

        // Cero or less will find all
        Assert.AreEqual(14, UserEncrypted.FindMany(u => u.count < 14, limit: 0).Data.Length);
    }




    [Test]
    public void A230_FindAll_WillFindAllDocuments()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // Find all document when no documents are stores
        var opp = UserEncrypted.FindAll();
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data.Length == 0);


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find all document
        opp = UserEncrypted.FindAll();
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 6);

    }

    [Test]
    public void A233_FindAll_IfLimitPassedOnlyThatreadsWillBeDone()
    {

        // Create one document
        Debug.Log("Save");
        for (int i = 0; i < 20; i++)
            new UserEncrypted { count = 66, name = "Pedro" }.Save();

        // 20 one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 20);

        // Find all document will return all
        Assert.AreEqual(20, UserEncrypted.FindAll().Data.Length);

        // Limit will limit reads
        Assert.AreEqual(12, UserEncrypted.FindAll(12).Data.Length);

        // Limit will limit reads
        Assert.AreEqual(1, UserEncrypted.FindAll(1).Data.Length);

        // Cero or less will find all
        Assert.AreEqual(20, UserEncrypted.FindAll(-1).Data.Length);

        // Cero or less will find all
        Assert.AreEqual(20, UserEncrypted.FindAll(0).Data.Length);
    }




    [Test]
    public void A300_UpdateById_01WillFindAndUpdateAnDocumentIfExist()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432060", count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { _id = "4961429416443432061", count = 66, name = "Pedro" };
        var newd3 = new UserEncrypted { _id = "4961429416443432062", count = 66, name = "Pedro" };

        // The first one will be saved
        Debug.Log("Save");
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());

        // Only one document will be stored
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.Count() == 3);


        // Find the document by the id
        Debug.Log("Save");
        var opp = UserEncrypted.FindById("4961429416443432060");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Update the document
        Debug.Log("Update");
        var upp = UserEncrypted.UpdateById(d => { d.count = 11; d.name = "Ema"; return d; }, "4961429416443432060");
        Assert.IsTrue(upp);

        // Find the document by the id
        Debug.Log("FindAgain");
        opp = UserEncrypted.FindById("4961429416443432060");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 11);
        Assert.IsTrue(opp.Data.name == "Ema");




        // Try to Update an unexistent document will return false
        Debug.Log("UpdateUnexistent");
        var opp2 = UserEncrypted.UpdateById(d => { d.count = 11; d.name = "Ema"; return d; }, "4961429416443432069");
        Assert.IsFalse(opp2);
        Assert.IsTrue(opp2 == 0);

        // Document is not stored
        Assert.IsTrue(UserEncrypted.Count() == 3);

    }

    [Test]
    public void A300_UpdateById_IfUpdatingThrowsError_DontUpdate()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432060", count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { _id = "4961429416443432061", count = 66, name = "Pedro" };
        var newd3 = new UserEncrypted { _id = "4961429416443432062", count = 66, name = "Pedro" };

        // The first one will be saved
        Debug.Log("Save");
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());

        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.Count() == 3);


        // Find the document by the id
        Debug.Log("Save");
        var opp = UserEncrypted.FindById("4961429416443432060");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Update the document
        Debug.Log("Update");
        var upp = UserEncrypted.UpdateById(d => { d.count = 11; d.name = "Ema"; throw new Exception("Expected exception"); }, "4961429416443432060");
        Assert.IsFalse(upp);

        // Find the same document by the id
        Debug.Log("Save");
        opp = UserEncrypted.FindById("4961429416443432060");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);
        Assert.IsTrue(opp.Data.name != "Ema");




        // Try to Update an unexistent document will return false
        Debug.Log("UpdateUnexistent");
        var opp2 = UserEncrypted.UpdateById(d => { d.count = 11; d.name = "Ema"; throw new Exception("Expected exception"); }, "4961429416443432000");
        Assert.IsFalse(opp2);
        Assert.IsTrue(opp2 == 0);


    }

    [Test]
    public void A300_UpdateById_61InvalidOrNullKeyOrUpdateFunc_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateById(u => { u.count = 88; return u; }, null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateById(u => { u.count = 88; return u; }, ""));
        Assert.Throws<FormatException>(() => UserEncrypted.UpdateById(u => { u.count = 88; return u; }, "343432"));
        Assert.Throws<FormatException>(() => UserEncrypted.UpdateById(u => { u.count = 88; return u; }, "f43f34ff"));
        Assert.Throws<FormatException>(() => UserEncrypted.UpdateById(u => { u.count = 88; return u; }, "4332 333 444 55  22"));
        Assert.Throws<FormatException>(() => UserEncrypted.UpdateById(u => { u.count = 88; return u; }, "433232893874673.254"));

        // Null update func
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateById(null, "2893128734678923478"));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateById(null, null));
        Assert.Throws<FormatException>(() => UserEncrypted.UpdateById(null, "dd"));

        Assert.DoesNotThrow(() => UserEncrypted.UpdateById(d => { return d; }, "4332328938746732254"));
    }




    [Test]
    public void A310_UpdateOne_01WillUpdateAnDocumentIfExist()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 99, name = "Ale" };

        Debug.Log("Save");
        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Debug.Log("Save");
        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 5);
        Debug.Log("Save");
        // Update a document
        var upp = UserEncrypted.UpdateOne(d => { d.count = 11; return d; }, d => d.count == 66);
        Debug.Log(upp);
        Assert.IsTrue(upp);
        Assert.IsTrue(upp == 1);
        Debug.Log("Save");
        // Find that document again, because are two with same count
        var opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);
        // Find updated document
        opp = UserEncrypted.FindOne(d => d.count == 11);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 11);
        Debug.Log("Save");

        // If you try to update an unexistent document will return false
        upp = UserEncrypted.UpdateOne(d => { d.count = 2; return d; }, d => d.name == "Ema" );
        Assert.IsFalse(upp);
        Debug.Log("Save");
    }

    [Test]
    public void A311_UpdateOne_IfPredicateThrowsError_IsLikeDontFindAny()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 99, name = "Ale" };

        Debug.Log("Save");
        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.Count() == 5);
        Debug.Log("Save");

        // Update a document
        var upp = UserEncrypted.UpdateOne(d => { d.count = 11; return d; }, d => throw new Exception("Expected exception"));
        Assert.IsFalse(upp);
    }

    [Test]
    public void A312_UpdateOne_IfUpdatingThrowsError_DontUpdate()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };

        Debug.Log("Save");
        // The first one will be saved
        Assert.IsTrue(newd1.Save());

        Debug.Log("Save");
        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 1);
        Debug.Log("Save");
        // Update a document
        var upp = UserEncrypted.UpdateOne(d => { d.count = 11; d.name = "Ema"; throw new Exception("Expected exception"); }, d => d.count == 66);
        Assert.IsFalse(upp);

        // Find that document again, because is not updated
        var opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);
        Assert.IsTrue(opp.Data.name == "Pedro");

        // If you try to update an unexistent document will return false
        upp = UserEncrypted.UpdateOne(d => { d.count = 11; d.name = "Ema"; throw new Exception("Expected exception"); }, d => d.count == 11);
        Assert.IsFalse(upp);
    }

    [Test]
    public void A310_UpdateOne_61NullUpdatingFuncOrPredicate_WillThrowError()
    {

        // Invalid
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateOne(d => { d.count = 22; return d; }, null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateOne(null, d => d.count == 22));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateOne(null, null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateOne(null, d => true));

        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateOne(d => { return d; }, null));

        Assert.DoesNotThrow(() => UserEncrypted.UpdateOne(d => { return d; }, d => true));
    }




    [Test]
    public void A320_UpdateMany_01WillFindAndUpdateIfExist()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find a document
        var opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }

        // Update that documents
        var upp = UserEncrypted.UpdateMany(d => { d.count = 22; return d; }, d => d.count == 66);
        Assert.IsTrue(upp);

        // Find a document
        opp = UserEncrypted.FindMany(d => d.count == 22);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 22);
        }
        // Find a document
        opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data.Length == 0);


        // If you try to update an unexistent document will return true and 0
        upp = UserEncrypted.UpdateMany(d => { d.name = "Pedro"; return d; }, d => d.name == "Ema");
        Assert.IsFalse(opp);
        Assert.IsTrue(opp == 0);

    }

    [Test]
    public void A321_UpdateMany_IfPredicateThrowsError_IsLikeDontFindAny()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find a document
        var opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }

        // Update that documents
        var upp = UserEncrypted.UpdateMany(d => { d.count = 22; return d; }, d => throw new Exception("Expected exception"));
        Assert.IsTrue(upp);
        Assert.AreEqual(0, (int)upp);

        // Find same document
        opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }


        // If you try to update an unexistent document will return true and 0
        upp = UserEncrypted.UpdateMany(d => { d.name = "Ema"; return d; }, d => throw new Exception("Expected exception"));
        Assert.IsTrue(upp);
        Assert.AreEqual(0, (int)upp);

    }

    [Test]
    public void A321_UpdateMany_IfUpdatingThrowsError_DontUpdate()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find a document
        var opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }

        // Update that documents
        var upp = UserEncrypted.UpdateMany(d => { d.count = 22; d.name = "Ema"; throw new Exception("Expected exception"); }, d => d.count == 66);
        Assert.IsTrue(upp);
        Assert.AreEqual(0, (int)upp);

        // Find same document
        opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
            Assert.IsTrue(d.name != "Ema");
        }


        // If you try to update an unexistent document will return true and 0
        upp = UserEncrypted.UpdateMany(d => { d.count = 22; d.name = "Ema"; throw new Exception("Expected exception"); }, d => d.count == 11);
        Assert.IsTrue(upp);
        Assert.AreEqual(0, (int)upp);

    }

    [Test]
    public void A320_UpdateMany_61NullPredicateOrUpdating_WillThrowError()
    {

        // Invalid
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateMany(d => { d.count = 22; return d; }, null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateMany(null, d => d.count == 22));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateMany(null, null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.UpdateMany(d => { return d; }, null));

        Assert.DoesNotThrow(() => UserEncrypted.UpdateMany(d => { return d; }, d => true));
    }




    [Test]
    public void A330_UpdateAll_WillUppdateAllDocuments()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // Update all document when no documents are stored
        var upp = UserEncrypted.UpdateAll(d => { d.count = 11; return d; });
        Assert.IsTrue(upp);
        Assert.IsTrue(upp == 0);


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find all documents
        upp = UserEncrypted.UpdateAll(d => { d.count = 11; return d; });
        Assert.IsTrue(upp);
        Assert.IsTrue(upp == 6);
        Assert.IsTrue(UserEncrypted.FindMany(d => d.count == 11).Data.Length == 6);

    }

    [Test]
    public void A331_UpdateAll_IfUpdatingThrowsError_DontUpdate()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // Update all document when no documents are stored
        var upp = UserEncrypted.UpdateAll(d => { d.count = 11; return d; });
        Assert.IsTrue(upp);
        Assert.IsTrue(upp == 0);


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find all documents
        upp = UserEncrypted.UpdateAll(d => { d.count = 11; d.name = "Ema"; throw new Exception("Expected exception"); });

        Assert.IsTrue(upp);
        Assert.AreEqual(0, (int)upp);
        Assert.IsTrue(UserEncrypted.FindMany(d => d.count == 11 || d.name == "Ema").Data.Length == 0);

    }




    [Test]
    public void A400_DeleteById_01WillDeleteAnDocumentAndReturnTrueIfDeletedOrNoExist()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { _id = "4961429416443432060", count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { _id = "4961429416443432061", count = 66, name = "Pedro" };
        var newd3 = new UserEncrypted { _id = "4961429416443432062", count = 66, name = "Pedro" };
        var newd4 = new UserEncrypted { _id = "4961429416443432063", count = 66, name = "Pedro" };
        var newd5 = new UserEncrypted { _id = "4961429416443432064", count = 66, name = "Pedro" };

        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 5);

        // Find the document by the id
        var opp = UserEncrypted.FindById("4961429416443432060");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Delete the document
        Assert.IsTrue(UserEncrypted.DeleteById("4961429416443432060"));

        // If you try to find an unexistent document will return null
        var opp2 = UserEncrypted.FindById("4961429416443432060");
        Assert.IsFalse(opp2);
        Assert.IsTrue(opp2.Data == null);

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 4);

        // Find the document by the id
        opp = UserEncrypted.FindById("4961429416443432061");
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Delete the document
        Assert.IsTrue(UserEncrypted.DeleteById("4961429416443432061"));

        // If you try to find an unexistent document will return null
        opp2 = UserEncrypted.FindById("4961429416443432061");
        Assert.IsFalse(opp2);
        Assert.IsTrue(opp2.Data == null);

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 3);


        // Delete unexistent document
        Assert.IsTrue(UserEncrypted.DeleteById("4961429416443432070"));


        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 3);
    }

    [Test]
    public void A400_DeleteById_61InvalidOrNullKey_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.DeleteById(null));
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.DeleteById(""));
        Assert.Throws<FormatException>(() => UserEncrypted.DeleteById("343432"));
        Assert.Throws<FormatException>(() => UserEncrypted.DeleteById("f43f34ff"));
        Assert.Throws<FormatException>(() => UserEncrypted.DeleteById("4332 333 444 55  22"));
        Assert.Throws<FormatException>(() => UserEncrypted.DeleteById("433232893874673.254"));
        Assert.DoesNotThrow(() => UserEncrypted.DeleteById("4332328938746732254"));
    }




    [Test]
    public void A410_DeleteOne_61NullPredicate_WillThrowError()
    {
        Debug.Log("Test");

        // Delete the directory to clear it
        try { Directory.Delete(UserEncrypted.LocationPath, true); } catch (Exception) { }
        UserEncrypted.DeleteAll();

        // Find the document by the id
        Debug.Log("Test");
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.DeleteOne(null));
        Debug.Log("Test");
        Assert.DoesNotThrow(() => UserEncrypted.DeleteOne( d => true));
        Debug.Log("Test");
    }

    [Test]
    public void A410_DeleteOne_01WillDeleteAnDocumentAndReturnTrueIfDeletedOrNoExist()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Debug.Log("Save");
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());

        // Only one document will be stored
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.Count() == 5);

        // Find a document
        Debug.Log("Save");
        var opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Delete that document
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.DeleteOne(d => d.count == 66));

        // Still can be Finded debause are two with count == 66
        Debug.Log("Save");
        opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Delete that document
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.DeleteOne(d => d.count == 66));

        // That document cant be find any more, two are deleted
        Debug.Log("Save");
        opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsFalse(opp);


        // Only one document will be stored
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.Count() == 3);




        // If you try to delete unexistent document will return true
        Debug.Log("Test");
        var opp2 = UserEncrypted.DeleteOne(d => d.name == "Ema");
        Debug.Log("Save: " + opp2);
        Assert.IsTrue(opp2);
        // If you try to find an unexistent document will return true
        Debug.Log("Save");
        opp2 = UserEncrypted.DeleteOne(d => d.count == 100);
        Assert.IsTrue(opp2);

    }

    [Test]
    public void A410_DeleteOne_IfPredicateThrowsError_IsLikeDontFindAny()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };


        // The first one will be saved
        Debug.Log("Save");
        Assert.IsTrue(newd1.Save());

        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.Count() == 1);

        // Find a document
        Debug.Log("Save");
        var opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);

        // Delete that document
        Debug.Log("Save");
        Assert.IsTrue(UserEncrypted.DeleteOne(d => throw new Exception("Expected exception")));

        // Find same document
        Debug.Log("Save");
        opp = UserEncrypted.FindOne(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.count == 66);




        // If you try to delete unexistent document will return true
        Debug.Log("Test");
        var opp2 = UserEncrypted.DeleteOne(d => throw new Exception("Expected exception"));
        Debug.Log("Save: " + opp2);
        Assert.IsTrue(opp2);

    }




    [Test]
    public void A420_DeleteMany_WillDeleteFided()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Find a document
        var opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }

        // Delete that documents
        var dpp = UserEncrypted.DeleteMany(d => d.count == 66);
        Assert.IsTrue(dpp);
        Assert.IsTrue(dpp == 2); // Two deleted

        // Cant Find a that documents
        opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsFalse(opp);
        Assert.IsTrue(opp.Data.Length == 0);

        // Delete unexistent documents
        dpp = UserEncrypted.DeleteMany(d => d.count == 11);
        Assert.IsTrue(dpp);
        Assert.IsTrue(dpp == 0); // Cero deleted


        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 4);

    }

    [Test]
    public void A421_DeleteMany_IfPredicateThrowsError_IsLikeDontFindAny()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 2);

        // Find a document
        var opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }

        // Delete that documents
        var dpp = UserEncrypted.DeleteMany(d => throw new Exception("Expected exception"));
        Assert.IsTrue(dpp);
        Assert.IsTrue(dpp == 0); // Two deleted

        // Find same documents
        opp = UserEncrypted.FindMany(d => d.count == 66);
        Assert.IsTrue(opp);
        Assert.IsTrue(opp.Data.Length == 2);
        foreach (var d in opp.Data)
        {
            Assert.IsTrue(d.count == 66);
        }

        // Delete unexistent documents
        dpp = UserEncrypted.DeleteMany(d => throw new Exception("Expected exception"));
        Assert.IsTrue(dpp);
        Assert.IsTrue(dpp == 0); // Cero deleted

    }




    [Test]
    public void A420_DeleteAll_WillDeleteAllDocuments()
    {

        // Create one document
        Debug.Log("Save");
        var newd1 = new UserEncrypted { count = 66, name = "Pedro" };
        var newd2 = new UserEncrypted { count = 66, name = "Paco" };
        var newd3 = new UserEncrypted { count = 77, name = "Benito" };
        var newd4 = new UserEncrypted { count = 88, name = "Juan" };
        var newd5 = new UserEncrypted { count = 33, name = "Juan" };
        var newd6 = new UserEncrypted { count = 99, name = "Ale" };


        // Find all document when no documents are stores
        var opp = UserEncrypted.DeleteAll();
        Assert.IsTrue(opp);
        Assert.IsTrue(opp == 0);


        // The first one will be saved
        Assert.IsTrue(newd1.Save());
        Assert.IsTrue(newd2.Save());
        Assert.IsTrue(newd3.Save());
        Assert.IsTrue(newd4.Save());
        Assert.IsTrue(newd5.Save());
        Assert.IsTrue(newd6.Save());

        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 6);

        // Delete all document
        opp = UserEncrypted.DeleteAll();
        Assert.IsTrue(opp);


        // Only one document will be stored
        Assert.IsTrue(UserEncrypted.Count() == 0);

    }




    [Test]
    public void A430_DeleteMany_61NullPredicate_WillThrowError()
    {

        // Find the document by the id
        Assert.Throws<ArgumentNullException>(() => UserEncrypted.DeleteMany(null));
        Assert.DoesNotThrow(() => UserEncrypted.DeleteAll());

    }


}
